<!-- 測試時可先移除 ngIf，確保 Splitter 一定顯示 -->
<p-splitter
  [panelSizes]="[70, 20, 10]"
  [style]="{ height: '100vh' }"
  class="mb-8"
  [stateKey]="'panel1'"
  (onResizeStart)="onSplitterResizeStart()"
  (onResizeEnd)="onSplitterResizeEnd()"
>
  <!-- Panel 1: 左側 -->
  <ng-template #panel>
    <div class="flex flex-col items-center justify-start h-full gap-2">
      <div class="w-full organization-chart-top">
        <p-organizationChart [value]="[selectedContract ? getOrgChartData(selectedContract) : getDefaultOrgChartData()]" styleClass="w-full" [collapsible]="true">
          <ng-template let-node pTemplate="person">
            <div class="flex flex-col items-center">
              <span class="font-bold mb-1">{{ node.data.name || '—' }}</span>
              <span class="text-xs text-gray-500">{{ node.data.role || '—' }}</span>
            </div>
          </ng-template>
        </p-organizationChart>
      </div>
      <p-table [value]="contracts" styleClass="p-datatable-sm w-full" [tableStyle]="{ 'font-size': '13px' }" [responsiveLayout]="'scroll'"
        selectionMode="single" [(selection)]="selectedContract" dataKey="code" [rowHover]="true"
        (onRowSelect)="onRowSelect($event)">
        <ng-template pTemplate="header">
          <tr>
            <th>編號</th>
            <th>狀態</th>
            <th>訂單編號</th>
            <th>專案編號</th>
            <th>工程名稱</th>
            <th>合約金額</th>
            <th>已請款金額</th>
            <th>請款%</th>
            <th>尚未請款%</th>
            <th>操作</th>
            <th>申請</th>
            <th>檔案</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-contract let-rowIndex="rowIndex">
          <tr [pSelectableRow]="contract" [pSelectableRowIndex]="rowIndex"
            [class.bg-blue-50]="selectedContract?.code === contract.code"
            (click)="selectContract(contract)">
            <td>{{ contract.code }}</td>
            <td>{{ contract.status }}</td>
            <td>{{ contract.orderNo }}</td>
            <td>{{ contract.projectNo }}</td>
            <td>{{ contract.projectName }}</td>
            <td>{{ contract.contractAmount }}</td>
            <td>{{ contract.invoicedAmount }}</td>
            <td>{{ contract.paymentPercent }}%</td>
            <td>{{ contract.pendingPercent }}%</td>
            <td (click)="$event.stopPropagation()">
              <button pButton type="button" icon="pi pi-info-circle" class="p-button-text p-0"
                (click)="toggleExpand(contract, $event)">詳細</button>
            </td>
            <td (click)="$event.stopPropagation()">
              <button pButton type="button" icon="pi pi-plus-circle" class="p-button-text p-0"
                (click)="applyPayment(contract)">申請</button>
            </td>
            <td (click)="$event.stopPropagation()">
              <label class="cursor-pointer">
                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5m0 0l5 5m-5-5v12" />
                </svg>
                <input type="file" class="hidden" accept="application/pdf,image/*" (change)="onContractFileSelected($event, contract)" [disabled]="!!contract.url || uploadingContractCode === contract.code" />
              </label>
              <span *ngIf="uploadingContractCode === contract.code" class="text-xs text-gray-500 ml-2">上傳中...</span>
              <a *ngIf="contract.url" [href]="contract.url" target="_blank" class="ml-2 text-blue-600 underline">檢視</a>
            </td>
          </tr>
          <tr *ngIf="contract.expanded">
            <td colspan="12">
              <div class="flex flex-col gap-2">
                <span>請款紀錄：</span>
                <ng-container *ngIf="contract.payments?.length; else noPayments">
                  <div *ngFor="let p of contract.payments" class="flex gap-4 items-center border-b pb-1">
                    <span>第{{ p.round }}次</span>
                    <span>{{ p.date | date:'yyyy/MM/dd HH:mm' }}</span>
                    <span>金額：{{ p.amount | number:'1.0-0' }}</span>
                    <span>百分比：{{ p.percent }}%</span>
                    <span>申請人：{{ p.applicant }}</span>
                    <span *ngIf="p.note">備註：{{ p.note }}</span>
                    <span>狀態：{{ p.status || '未知' }}</span>
                    <ng-container *ngIf="p.status === '初始'">
                      <button pButton type="button" label="送出申請" class="p-button-sm ml-2" (click)="toStatus(contract, p, '申請中')"></button>
                    </ng-container>
                    <ng-container *ngIf="p.status === '申請中'">
                      <button pButton type="button" label="送審" class="p-button-sm ml-2" (click)="toStatus(contract, p, '審核中')"></button>
                      <button pButton type="button" label="拒絕" class="p-button-sm ml-2 p-button-danger" (click)="toStatus(contract, p, '已拒絕')"></button>
                    </ng-container>
                    <ng-container *ngIf="p.status === '審核中'">
                      <button pButton type="button" label="開票" class="p-button-sm ml-2" (click)="toStatus(contract, p, '開票中')"></button>
                      <button pButton type="button" label="拒絕" class="p-button-sm ml-2 p-button-danger" (click)="toStatus(contract, p, '已拒絕')"></button>
                    </ng-container>
                    <ng-container *ngIf="p.status === '開票中'">
                      <button pButton type="button" label="放款" class="p-button-sm ml-2" (click)="toStatus(contract, p, '放款中')"></button>
                    </ng-container>
                    <ng-container *ngIf="p.status === '放款中'">
                      <button pButton type="button" label="完成" class="p-button-sm ml-2" (click)="toStatus(contract, p, '完成')"></button>
                    </ng-container>
                  </div>
                </ng-container>
                <ng-template #noPayments>
                  <span>尚無請款紀錄</span>
                </ng-template>
                <div class="flex flex-col gap-2 mt-2">
                  <div *ngFor="let s of statusList" class="flex items-center gap-2">
                    <span style="min-width: 60px;">{{ s }}</span>
                    <p-progressBar [value]="getStatusPercent(contract, s)" [showValue]="true" style="flex:1; min-width:120px;"></p-progressBar>
                    <span style="min-width: 32px; text-align:right;">{{ getStatusPercent(contract, s) }}%</span>
                  </div>
                </div>
                <div *ngIf="getStatusPercent(contract, '已拒絕') > 0" class="text-red-600 mt-2">
                  已拒絕: {{ getStatusPercent(contract, '已拒絕') }}%（退件不計入流程進度）
                </div>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      <button pButton type="button" label="建立合約" (click)="showStepper = true" class="mt-4 w-full"></button>
      <p-dialog [(visible)]="showStepper" [modal]="true" [closable]="true" [dismissableMask]="true" [style]="{width: '480px'}" header="建立合約" (onHide)="showStepper = false">
        <app-stepbutton (contractCreated)="onStepperCreated($event)"></app-stepbutton>
      </p-dialog>
    </div>
  </ng-template>
  <!-- Panel 2: 中間，垂直再分上下 -->
  <ng-template #panel>
    <p-splitter [stateKey]="'panel2'" layout="vertical" [panelSizes]="[70, 30]"
      (onResizeStart)="onVerticalSplitterResizeStart()"
      (onResizeEnd)="onVerticalSplitterResizeEnd()">
      <ng-template #panel [stateKey]="'panel2-top'">
        <div class="flex flex-col items-center justify-center h-full w-full" style="position: relative; height: 100%;">
          <object *ngIf="safeUrl" [data]="safeUrl" type="application/pdf" width="100%" height="100%" style="border: none; display: block;">
            <div>無法預覽 PDF，請<a [href]="safeUrl" target="_blank" class="text-blue-600 underline">下載檔案</a>。</div>
          </object>
          <div *ngIf="dragging" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: transparent; cursor: move;"></div>
          <div *ngIf="!safeUrl" class="text-gray-500">請選擇有 PDF 檔案的合約</div>
        </div>
      </ng-template>
      <ng-template #panel [stateKey]="'panel2-bottom'">
        <!-- 下半部內容（可留空或自訂） -->
      </ng-template>
    </p-splitter>
  </ng-template>
  <!-- Panel 3: 右側，單一區 -->
  <ng-template #panel [stateKey]="'panel3'">
    <div class="flex flex-col items-center justify-center h-full gap-2 w-full">
      <p-timeline [value]="selectedContract ? getEventTimeline(selectedContract) : []" align="alternate" *ngIf="selectedContract">
        <ng-template pTemplate="content" let-item>
          <div>
            <div>{{ item.label }}</div>
            <div class="text-xs text-gray-500">{{ item.date | date:'yyyy/MM/dd HH:mm' }}</div>
          </div>
        </ng-template>
      </p-timeline>
      <div *ngIf="!selectedContract" class="text-gray-500">請選擇合約以檢視歷程</div>
      <div *ngIf="selectedContract" style="width:100%;">
        <div class="font-bold mb-2">事件紀錄</div>
        <div *ngFor="let log of getEventLog(selectedContract)" class="text-xs mb-1">{{ log }}</div>
      </div>
    </div>
  </ng-template>
</p-splitter>
<p-dialog [visible]="showRequest !== null" [modal]="true" [closable]="true" header="申請請款" [style]="{width: '400px'}" (onHide)="closeRequestDialog()">
  <form *ngIf="showRequest" (ngSubmit)="submitPayment()" class="flex flex-col gap-4">
    <div class="flex gap-4">
      <label>申請金額
        <input pInputText type="number" [(ngModel)]="paymentAmount" name="paymentAmount" required (ngModelChange)="onPaymentAmountChange($event)" />
      </label>
      <label>百分比
        <input pInputText type="number" [(ngModel)]="paymentPercent" name="paymentPercent" required min="0" max="100" (ngModelChange)="onPaymentPercentChange($event)" />
      </label>
    </div>
    <label>備註
      <input pInputText [(ngModel)]="paymentNote" name="paymentNote" />
    </label>
    <button pButton type="submit" label="送出" [disabled]="!paymentAmount || !paymentPercent"></button>
  </form>
</p-dialog>
