<!-- 測試時可先移除 ngIf，確保 Splitter 一定顯示 -->
<p-splitter [panelSizes]="[25, 65, 10]" [style]="{ height: '100vh' }" class="mb-8">
    <!-- Panel 1: 左側 -->
         <ng-template #panel [stateKey]="'panel1'">
              <!-- Panel 1 內容 -->
      <div class="flex flex-col items-center justify-center h-full gap-2">
        <p-table [value]="contracts" styleClass="p-datatable-sm w-full" [tableStyle]="{ 'font-size': '13px' }" [responsiveLayout]="'scroll'"
          selectionMode="single" [(selection)]="selectedContract" dataKey="code">
          <ng-template pTemplate="header">
            <tr>
              <th>編號</th>
              <th>狀態</th>
              <th>訂單號</th>
              <th>專案編號</th>
              <th>工程名稱</th>
              <th>合約金額</th>
              <th>已請款金額</th>
              <th>請款%</th>
              <th>尚未請款%</th>
              <th>操作</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-contract let-rowIndex="rowIndex">
            <tr>
              <td>{{ contract.code }}</td>
              <td>{{ contract.status }}</td>
              <td>{{ contract.orderNo }}</td>
              <td>{{ contract.projectNo }}</td>
              <td>{{ contract.projectName }}</td>
              <td>{{ contract.contractAmount }}</td>
              <td>{{ contract.invoicedAmount }}</td>
              <td>{{ contract.paymentPercent }}%</td>
              <td>{{ contract.pendingPercent }}%</td>
              <td>
                <label class="cursor-pointer">
                  <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5m0 0l5 5m-5-5v12" />
                  </svg>
                  <input type="file" class="hidden" accept="application/pdf,image/*" (change)="onContractFileSelected($event, contract)" [disabled]="!!contract.url || uploadingContractCode === contract.code" />
                </label>
                <span *ngIf="uploadingContractCode === contract.code" class="text-xs text-gray-500 ml-2">上傳中...</span>
                <a *ngIf="contract.url" [href]="contract.url" target="_blank" class="ml-2 text-blue-600 underline">檢視</a>
              </td>
            </tr>
            <tr *ngIf="contract.expanded">
              <td colspan="10">
                <div class="flex flex-wrap gap-2 items-center">
                  <span>請款狀態: {{ contract.paymentStatus }}</span>
                  <span>發票狀態: {{ contract.invoiceStatus }}</span>
                  <span>第 {{ contract.paymentRound }} 次請款</span>
                  <span>備註: {{ contract.note }}</span>
                  <span class="flex items-center">尚未請款:
                    <input type="range" min="0" max="100" [ngModel]="contract.pendingPercent" class="w-32 align-middle mx-2" disabled />
                    <span>{{ contract.pendingPercent }}%</span>
                  </span>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
        <button pButton type="button" label="建立合約" (click)="addContract()" class="mt-4 w-full"></button>
      </div>
    </ng-template>
  <!-- Panel 2: 中間，垂直再分上下 -->
    <ng-template #panel [stateKey]="'panel2'">
      <p-splitter layout="vertical" [panelSizes]="[70, 30]">
        <ng-template #panel [stateKey]="'panel2-top'">
                  <!-- 上半部內容 -->
          <div class="flex flex-col items-center justify-center h-full w-full">
            <ng-container *ngIf="selectedContract && selectedContract.url && isPdfUrl(selectedContract.url); else noPdf">
              <iframe
                [attr.src]="selectedContract.url"
                width="100%"
                height="500"
                style="border: none;"
              ></iframe>
            </ng-container>
            <ng-template #noPdf>
              <div class="text-gray-500">
                <div *ngIf="!selectedContract">請選擇合約</div>
                <div *ngIf="selectedContract && !selectedContract.url">請上傳PDF檔案</div>
                <div *ngIf="selectedContract && selectedContract.url && !isPdfUrl(selectedContract.url)">請上傳PDF格式檔案</div>
              </div>
            </ng-template>
          </div>
        </ng-template>
        <ng-template #panel [stateKey]="'panel2-bottom'">
              <!-- 下半部內容（可留空或自訂） -->
        </ng-template>
      </p-splitter>
    </ng-template>
  <!-- Panel 3: 右側，單一區 -->
    <ng-template #panel [stateKey]="'panel3'">
      <div class="flex flex-col items-center justify-center h-full gap-2 w-full">
        <p-timeline [value]="selectedContract ? [selectedContract] : []" align="alternate" *ngIf="selectedContract">
          <ng-template pTemplate="content" let-item>
            <div>
              <div>合約編號：{{ item.code }}</div>
              <div>狀態：{{ item.status }}</div>
              <div>專案名稱：{{ item.projectName }}</div>
              <div *ngIf="item.url"><a [href]="item.url" target="_blank" class="text-blue-600 underline">檢視檔案</a></div>
            </div>
          </ng-template>
        </p-timeline>
        <div *ngIf="!selectedContract" class="text-gray-500">請選擇合約以檢視歷程</div>
      </div>
    </ng-template>
  </p-splitter>
